/*!
 * RallyDev Extension Bookmarklet v0.5
 *
 * Copyright 2014 Miroslav Sommer
 * Released under the MIT license
 *
 * Date: 2014-05-19T23:00Z
 *
 * Add this bookmarklet to your browser bookmarks:
 *
 * javascript:$.getScript('https://raw.githubusercontent.com/mirogta/rallydev-extension-bookmarklet/master/rallydevbookmarklet.min.js');
 *
 */
console.log=function(n,t,i){var u=i('<div id="_icon">RallyDev Extensions v0.5<\/div>'),r,f;u.appendTo("#footer");u.css({position:"absolute",bottom:"12px",right:"30px",padding:"2px",color:"#fff",border:"1px inset #aaa"});r=i('<div id="_logger"><\/div>');r.appendTo("#footer");r.css({position:"absolute",bottom:"12px",right:"30px",padding:"4px",background:"#fff",border:"1px inset #aaa",width:"1000px",height:"100px",overflow:"auto"});f=27;r.hide();i(n).on("keyup",function(n){n.keyCode===f&&r.toggle()});return function(n){var i=new Date;r.append("<small>"+i.toISOString()+"<\/small>:"+n+"<br/>");t.call(console,n);r[0].scrollTop=r[0].scrollHeight}}(window.document,console.log,$);console.log("Starting Miro's RallyDev Extension v0.5");window.open=function(n,t){function e(){console.log("- attachPopupLoadedEvent");console.log("- popup document: "+i.document);setTimeout(r,100)}function r(){if(i.document.readyState!=="complete"){u=!1;setTimeout(r,100);return}i.window&&setTimeout(r,1e3);u===!1&&(console.log("- document ready"),u=!0,o(i.jQuery))}function o(n){if(typeof n=="undefined"||n===null||n("#itemForm").length===0){console.log("- jQuery not ready, retry");setTimeout(r,100);return}console.log("- running enhancemenets");var t=n('input[name="editorType"]').val(),i=n('input[name="editorMode"]').val();console.log("- editorType:"+t+", editorMode:"+i);i==="create"&&t==="task"&&s(n)}function s(n){var r,t,i;console.log("- Create Task detected");r=n("#itemForm");console.log("- form:"+r);t="";t+='<div class="_container">';t+='<style type="text/css">';t+="._container {padding:10px;}";t+="._container * {font-size:medium; padding:4px; margin: 4px;}";t+="._container label {width:100px; display:inline-block;}";t+="._container input {width:20px; display:inline-block;}";t+="._container button {width:160px; display:inline-block;}";t+="._container ._title {font-weight:bold; border-bottom: 1px solid #000;}";t+="._container ._names {text-align:center;}";t+="._container ._actions {text-align:center; border-top: 1px solid #000;}";t+="._container ._name {width:500px;}";t+="._container ._help {margin-top:20px; color: #33AA33;}";t+="<\/style>";t+='<div class="_title">Create Task<\/div>';t+='<div class="_names">';t+='<button data-skill="Development" data-name="DEV: ">DEV<\/button>';t+='<button data-skill="Development" data-name="DEV: code review" data-next="true">DEV: code review<\/button>';t+='<button data-skill="Test" data-name="QA: ">QA<\/button>';t+='<button data-skill="Test" data-name="QA: test review" data-next="true">QA: test review<\/button>';t+="<\/div>";t+='<div><label>Name:<\/label><input type="text" class="_name"/><\/div>';t+='<div><label>Hours:<\/label><input type="text" class="_hours"/><\/div>';t+="<div><label>Ready:<\/label>&#10004;<\/div>";t+='<div><label>Skill:<\/label><span class="_skill"><\/span><\/div>';t+='<div class="_actions">';t+='<button data-target="save_and_close_btn">Save and Close<\/button>';t+='<button data-target="save_and_new_btn">Save and New<\/button>';t+='<button data-target="save_btn">Save<\/button>';t+='<button data-target="cancel_btn">Cancel<\/button>';t+="<\/div>";t+='<div class="_help">Press Esc key to toggle between the original and optimised view.<\/div>';t+="<\/div>";console.log("- adding new form");n(t).insertBefore(r);i=n("._container");f(i,r);console.log("- name buttons");n("._names button",i).on("click",function(){var t=n(this).data("skill"),r=n(this).data("name"),u=n(this).data("next");n('select option[value="'+t+'"]').parent().val(t);n("input._name",i).val(r).trigger("keyup").focus();n("span._skill",i).text(t);u&&n("._hours",i).focus()});console.log("- focus on name");n("input._name",i).focus();console.log("- update name");n("input._name",i).on("keyup",function(){var t=n(this).val();n('input[name="name"]').val(t)});console.log("- update estimate and time remaining");n("._hours",i).on("keyup",function(){var t=n(this).val();n('input[name="estimate"],input[name="remaining"]').val(t)});console.log("- add action buttons");n("div._actions button",i).on("click",function(){f(i,r);var t=n(this).data("target");switch(t){case"save_and_close_btn":return execute("task","createAndClose",!1),!1;case"save_and_new_btn":return execute("task","createAndNew",!1),!1;case"save_btn":return execute("task","create",!1),!1;case"cancel_btn":return confirmCancel(),!1}});console.log("- check Ready");n('input[name="ready"]').prop("checked",!0);console.log("- hide Owner row");n('select[name="owner"]').parents("tr").hide();console.log("- pre-select Development skill");n('select option[value="Development"]').parent().val("Development")}function f(n,r){console.log("- show/hide container and original on ESC key");var u=27;r.hide();n.show();t(i.document).on("keyup",function(t){t.keyCode===u&&(n.toggle(),r.toggle())})}var i=null,u=!1;return function(t,r,u){return console.log("- intercepted window.open("+t+","+r+","+u+")"),i=n.call(window,t,r,u),e(),i}}(window.open,$)