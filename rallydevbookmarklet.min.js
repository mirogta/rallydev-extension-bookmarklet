/*!
 * RallyDev Extension Bookmarklet v0.6
 *
 * Copyright 2014 Miroslav Sommer
 * Released under the MIT license
 *
 * Date: 2014-06-11T23:00Z
 *
 * Add this bookmarklet to your browser bookmarks:
 *
 * javascript:$.getScript('https://rawgit.com/mirogta/rallydev-extension-bookmarklet/master/rallydevbookmarklet.min.js');
 *
 */
console.log=function(n,t,i){var u=i('<div id="_icon">RallyDev Extensions v0.6<\/div>'),r,f;u.appendTo("#footer");u.css({position:"fixed",bottom:"12px",right:"30px",padding:"2px",background:"#000",color:"#fff",border:"1px inset #aaa"});r=i('<div id="_logger"><\/div>');r.appendTo("#footer");r.css({position:"fixed",bottom:"12px",right:"30px",padding:"4px",background:"#fff",border:"1px inset #aaa",width:"1000px",height:"100px",overflow:"auto"});f=27;r.hide();i(n).on("keyup",function(n){n.keyCode===f&&r.toggle()});return function(n){var i=new Date;r.append("<small>"+i.toISOString()+"<\/small>:"+n+"<br/>");t.call(console,n);r[0].scrollTop=r[0].scrollHeight}}(window.document,console.log,$);console.log("Starting Miro's RallyDev Extension v0.6");window.RallyExtensions={timeout:6e5},function(n,t){function u(){var t,i,n,u;console.log("- Adding custom styles");h();console.log("- Add extensions menu");t=$(".nav-bar li").parent();i=$('<li class="nav-tab" id="_extensionMenuItem"><a href="#/extensions">Extensions<\/a><\/li>');t.append(i);i.on("click",function(n){return n.preventDefault(),$(".nav-bar li").removeClass("nav-tab-active"),c(),!1});n=$('<li class="nav-tab" id="_refreshMenuItem"><i class="fa fa-refresh"><\/i><\/li>');t.append(n);u=$("#_refreshMenuItem i");n.data("active",!1);n.on("click",function(n){n.preventDefault();r=!r;u.html(r?"...":"");f()})}function f(){var n,i,u;r!==!1&&(n=$('a[href="'+document.location.hash+'"]'),n&&n.length>0&&(i=n[n.length-1],i.click()),u=t.timeout,setTimeout(f,u))}function h(){$("head").append(s);$("head").append(o)}function c(){console.log("- Display extensions content");var t="https://rally1.rallydev.com/slm/webservice/v2.0/project/"+i.project.ObjectID,n='<div class="portlet">';n+='<div class="titlebar"><span>RallyDev Extensions<\/span><\/div><br/>';n+='<div>Current Project: <a href="'+t+'">'+i.project.Name+"<\/a><\/div>";n+='<div>Releases: <select id="_releases"><\/select><\/div>';n+='<hr/><div id="_stories"><\/div>';n+="<\/div>";setTimeout(e,0);$("#content .portlet").parent().html(n);$("#_releases").on("change",l)}function l(){var n=$(this).val(),t="?query=((Project.Name%20%3D%20BUD)%20AND(Release.ObjectID%20%3D%20"+n+"))&shallowFetch=Name,FormattedID,ObjectID,Tasks&pagesize=50&order=Name%20desc";$.getJSON("https://rally1.rallydev.com/slm/webservice/v2.0/HierarchicalRequirement"+t,function(n){var t=[],r=n.QueryResult.Results;$.each(r,function(n,r){var f="https://rally1.rallydev.com/#/"+i.project.ObjectID+"ud/detail/userstory/"+r.ObjectID,u=r.FormattedID;t.push('<li id="_'+u+'"><a href="'+f+'">'+u+"<\/a> "+r.Name+"<\/option>");r.Tasks&&r.Tasks.Count>0&&setTimeout(function(){a(u,r.ObjectID)},100)});$("#_stories").html(t.join(""))})}function e(){var n="https://rally1.rallydev.com/slm/webservice/v2.0/project/"+i.project.ObjectID+"/Releases";$.getJSON(n+"?shallowFetch=Name,ObjectID&pagesize=50&order=Date%20desc",function(n){var t=[],i=n.QueryResult.Results;t.push("<option>Please select...<\/option>");$.each(i,function(n,i){t.push('<option value="'+i.ObjectID+'">'+i.Name+"<\/option>")});$("#_releases").html(t.join(""))})}function a(n,t){var i="https://rally1.rallydev.com/slm/webservice/v2.0/HierarchicalRequirement/"+t+"/Tasks";$.getJSON(i,function(t){var i=[],r=t.QueryResult.Results;i.push("<ul>");$.each(r,function(n,t){i.push("<li>"+t.Name+"<\/li>")});i.push("<\/ul>");$("#_"+n).append(i.join(""))})}function v(){$("#_extensionMenuItem").remove()}var o='<link href="https://rawgit.com/mirogta/rallydev-extension-bookmarklet/master/rallydevbookmarklet.css" rel="stylesheet" type="text/css">',s='<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">',i=n.getScope(),r=!1;u();window.extensions={init:u,reset:v,loadReleases:e}}(Rally,RallyExtensions)