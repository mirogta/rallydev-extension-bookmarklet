/*!
 * RallyDev Extension Bookmarklet v0.5
 *
 * Copyright 2014 Miroslav Sommer
 * Released under the MIT license
 *
 * Date: 2014-06-11T23:00Z
 *
 * Add this bookmarklet to your browser bookmarks:
 *
 * javascript:$.getScript('https://rawgit.com/mirogta/rallydev-extension-bookmarklet/master/rallydevbookmarklet.min.js');
 *
 */
console.log=function(n,t,i){var u=i('<div id="_icon">RallyDev Extensions v0.5<\/div>'),r,f;u.appendTo("#footer");u.css({position:"fixed",bottom:"12px",right:"30px",padding:"2px",background:"#000",color:"#fff",border:"1px inset #aaa"});r=i('<div id="_logger"><\/div>');r.appendTo("#footer");r.css({position:"fixed",bottom:"12px",right:"30px",padding:"4px",background:"#fff",border:"1px inset #aaa",width:"1000px",height:"100px",overflow:"auto"});f=27;r.hide();i(n).on("keyup",function(n){n.keyCode===f&&r.toggle()});return function(n){var i=new Date;r.append("<small>"+i.toISOString()+"<\/small>:"+n+"<br/>");t.call(console,n);r[0].scrollTop=r[0].scrollHeight}}(window.document,console.log,$);console.log("Starting Miro's RallyDev Extension v0.5"),function(n){function i(){var i,u,t,n,f;console.log("- Adding custom styles");o();console.log("- Add extensions menu");i=$(".nav-bar li").parent();u=$('<li class="nav-tab" id="_extensionMenuItem"><a href="#/extensions">Extensions<\/a><\/li>');i.append(u);u.on("click",function(n){return n.preventDefault(),$(".nav-bar li").removeClass("nav-tab-active"),s(),!1});t=$('<li class="nav-tab" id="_refreshMenuItem"><i class="fa fa-refresh"><\/i><\/li>');n=!1;i.append(t);f=$("#_refreshMenuItem i");t.data("active",!1);t.on("click",function(t){t.preventDefault();n=!n;f.html(n?"...":"");n===!0&&r()})}function r(){var n=$('a[href="'+document.location.hash+'"]');n&&n[0]&&n[0].click&&n[0].click();setTimeout(r,5e3)}function o(){$("head").append(e);$("head").append(f)}function s(){console.log("- Display extensions content");var i="https://rally1.rallydev.com/slm/webservice/v2.0/project/"+t.project.ObjectID,n='<div class="portlet">';n+='<div class="titlebar"><span>RallyDev Extensions<\/span><\/div><br/>';n+='<div>Current Project: <a href="'+i+'">'+t.project.Name+"<\/a><\/div>";n+='<div>Releases: <select id="_releases"><\/select><\/div>';n+='<hr/><div id="_stories"><\/div>';n+="<\/div>";setTimeout(u,0);$("#content .portlet").parent().html(n);$("#_releases").on("change",h)}function h(){var n=$(this).val(),i="?query=((Project.Name%20%3D%20BUD)%20AND(Release.ObjectID%20%3D%20"+n+"))&shallowFetch=Name,FormattedID,ObjectID,Tasks&pagesize=50&order=Name%20desc";$.getJSON("https://rally1.rallydev.com/slm/webservice/v2.0/HierarchicalRequirement"+i,function(n){var i=[],r=n.QueryResult.Results;$.each(r,function(n,r){var f="https://rally1.rallydev.com/#/"+t.project.ObjectID+"ud/detail/userstory/"+r.ObjectID,u=r.FormattedID;i.push('<li id="_'+u+'"><a href="'+f+'">'+u+"<\/a> "+r.Name+"<\/option>");r.Tasks&&r.Tasks.Count>0&&setTimeout(function(){c(u,r.ObjectID)},100)});$("#_stories").html(i.join(""))})}function u(){var n="https://rally1.rallydev.com/slm/webservice/v2.0/project/"+t.project.ObjectID+"/Releases";$.getJSON(n+"?shallowFetch=Name,ObjectID&pagesize=50&order=Date%20desc",function(n){var t=[],i=n.QueryResult.Results;t.push("<option>Please select...<\/option>");$.each(i,function(n,i){t.push('<option value="'+i.ObjectID+'">'+i.Name+"<\/option>")});$("#_releases").html(t.join(""))})}function c(n,t){var i="https://rally1.rallydev.com/slm/webservice/v2.0/HierarchicalRequirement/"+t+"/Tasks";$.getJSON(i,function(t){var i=[],r=t.QueryResult.Results;i.push("<ul>");$.each(r,function(n,t){i.push("<li>"+t.Name+"<\/li>")});i.push("<\/ul>");$("#_"+n).append(i.join(""))})}function l(){$("#_extensionMenuItem").remove()}var f='<link href="https://rawgit.com/mirogta/rallydev-extension-bookmarklet/master/rallydevbookmarklet.css" rel="stylesheet" type="text/css">',e='<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">',t=n.getScope();i();window.extensions={init:i,reset:l,loadReleases:u}}(Rally)